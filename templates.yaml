- triggers:
    - trigger: homeassistant
      event: start
    - trigger: time_pattern
      hours: "/1"
  sensor:
      - name: "rooms_temp_settler"
        unit_of_measurement: "째C"
        state: >
          {% set base_temp_1  = float(state_attr('climate.01LivingRoom','current_temperature'),0) %}
          {% if base_temp_1 == 0 %}
          {% set rooms_val_temp_1 = 21  | float %}
          {% else %}  
          {% set rooms_val_temp_1 = (base_temp_1*base_temp_1*-0.2825+10.808*base_temp_1-80.342)  %}
          {% endif %}  
          {{ (rooms_val_temp_1) | round(2) }}




############UF_temp#########################
- triggers:
    - trigger: homeassistant
      event: start
    - trigger: time_pattern
      hours: "/1"
    - device_id: 34a0cc5fb560a8a8fa512de09076cc8e
      domain: climate
      entity_id: b7699167c5acf518728de30ef1d1a1ba
      type: current_temperature_changed
      trigger: device
      above: 15
      below: 25
  ###      - entity_id: input_number.uf_refine_temp ### don't know how to attache
  sensor:
    - name: "UF_temp_settler"
      unit_of_measurement: "째C"
      state: >
        {% set base_temp_1  = float(state_attr('climate.01LivingRoom','current_temperature'),0) %}
        {% set UF_temp_ajust = float(states('input_number.uf_refine_temp'),0) %}
        {% if base_temp_1 == 0 %}
        {% set rooms_val_temp_1 = 21  | float %}
        {% else %}  
        {% set rooms_val_temp_1 = base_temp_1 %}
        {% endif %}  
        {% set rooms_val_temp_1=rooms_val_temp_1+UF_temp_ajust %}
        {{ (rooms_val_temp_1) | round(2) }}

- sensor:
  - default_entity_id: sensor.grid_power_state_2
    icon: "{% if  power_grid_state == 'off' %}\n  mdi:power-plug\n{% else %}\n  mdi:power-plug-off\n{%
      endif%}"
    name: Power Grid
    state: "{% set power_grid_state=states('switch.main_water') %} {% if power_grid_state
      == 'off' %}\n  On\n{% else %}\n  Off\n{% endif%}"

- sensor:
  - default_entity_id: sensor.main_water_2
    icon: "{% set valve_main_statese = states('switch.main_water') %} {% if valve_main_statese
      == 'on' %}\n  mdi:water-pump\n{% else %}\n  mdi:water-pump-off'\n{% endif %}"
    state: '{{ states(''switch.main_water'') }}'
    name: main_water_2


- sensor:
  - unit_of_measurement: 째C
    default_entity_id: sensor.uf_room_living
    state: '{% set base_temp  = float(state_attr(''climate.01LivingRoom'',''current_temperature''),0)
      %}   {{ (base_temp) }}'
    name: uf_room_living


################# !!!!!!!!!!!!!!!!! irrigation_pack_new !!!!!!!!!!!!!!!!!!!!!!!!!
### PARTS OF TEMPLATES for irrigation_pack_new 


#  workaround due to the fact normal way states('sensor.next_day_temp') was disabled
- triggers:
    - trigger: time_pattern
      hours: "/1"
  action:
    - service: weather.get_forecasts
      data:
        type: daily
      target:
        entity_id: weather.forecast_home
      response_variable: daily
  sensor:
    - name: "today_day_temp"
      state: "{{ daily['weather.forecast_home'].forecast[0].temperature|float(default=0) }}"
    - name: "next_day_temp"
      state: "{{ daily['weather.forecast_home'].forecast[1].temperature|float(default=0) }}"        
    - name: "today_day_precipitation"
      state: "{{ daily['weather.forecast_home'].forecast[0].precipitation|float(default=0) }}"
    - name: "next_day_precipitation"
      state: "{{ daily['weather.forecast_home'].forecast[1].precipitation|float(default=0) }}"        
    - name: "next_plus2_day_precipitation"
      state: "{{ daily['weather.forecast_home'].forecast[2].precipitation|float(default=0) }}"    


- sensor:
  - unit_of_measurement: mm
    default_entity_id: sensor.irrigation_unlimited_rain_yesterday_24
    state: '{{ float(states(''sensor.irrigation_unlimited_rain_1''),0)}}'
    name: irrigation_unlimited_rain_yesterday_24


# implemenation related to 5 AM hour when accurweather update data
- sensor:
  - unit_of_measurement: mm
    default_entity_id: sensor.irrigation_unlimited_rain_today
    state: '{% set rain_today_0 =float(states(''sensor.today_day_precipitation''),0)
      %} {% set rain_today_1 =float(states(''sensor.next_day_precipitation''),0) %}
      {% if now().hour in [0, 1, 2, 3, 4] %} {% set Ret_val_today =  rain_today_1
      %} {% else %} {% set Ret_val_today =  rain_today_0 %} {% endif %} {{ (Ret_val_today)
      }}'
    name: irrigation_unlimited_rain_today

# implemenation related to 5 AM hour when accurweather update data
- sensor:
  - unit_of_measurement: 째C
    default_entity_id: sensor.irrigation_unlimited_temp_max_today
    state: '{% set temp_max_forecast_0 =float(states(''sensor.today_day_temp''),0)
      %} {% set temp_max_forecast_1 =float(states(''sensor.next_day_temp''),0) %}
      {% if now().hour in [0, 1, 2, 3, 4] %} {% set Ret_val =  temp_max_forecast_1
      %} {% else %} {% set Ret_val =  temp_max_forecast_0 %} {% endif %} {{ (Ret_val)
      }}'
    name: irrigation_unlimited_temp_max_today


# implemenation related to 5 AM hour when accurweather update data
- sensor:
  - unit_of_measurement: mm
    default_entity_id: sensor.irrigation_unlimited_rain_tomorrow
    state: '{% set rain_tom_1 =float(states(''sensor.next_day_precipitation''),0)
      %} {% set rain_tom_2 =float(states(''sensor.next_plus_day_precipitation''),0)
      %} {% if now().hour in [0, 1, 2, 3, 4] %} {% set Ret_val_tomorrow =  rain_tom_2
      %} {% else %} {% set Ret_val_tomorrow =  rain_tom_1 %} {% endif %} {{ (Ret_val_tomorrow)
      }}'
    name: irrigation_unlimited_rain_tomorrow


### levels of rain
  ### today - 10 mm - irrigation is off / adjusted
  ### yesterday and tomorrow  - 20 mm - irrigation is off/ adjusted
  ### less than 20% - do not irrigate
  ### temp less than 15 - do not irrigate
- sensor:
  - unit_of_measurement: '%'
    default_entity_id: sensor.irrigation_unlimited_rain_ajastment
    state: '{% set rain_y = float(states(''sensor.irrigation_unlimited_rain_yesterday_24''),
      0) /10 %} {% set rain_n = float(states(''sensor.irrigation_unlimited_rain_today''),
      0) /7 %} {% set rain_t = float(states(''sensor.irrigation_unlimited_rain_tomorrow''),
      0) /8 %} {% set temp_max =states(''sensor.irrigation_unlimited_temp_max_today'')
      | float(-2) %} {% if temp_max < 15 %} {% set temp_adj = 0  | float %} {% elif
      temp_max >=15 and temp_max <19 %} {% set temp_adj =  2/4 | float  %} {% elif
      temp_max >=19 and temp_max <23 %} {% set temp_adj =  2/3 | float  %} {% elif
      temp_max >=23 and temp_max <28 %} {% set temp_adj =  1 | float  %} {% elif temp_max
      >=28 %} {% set temp_adj =  1 | float  %} {% endif %} {% set rain_adj = float((1
      - (rain_y+rain_n+rain_t))*temp_adj, 0)*100 %} {% if rain_adj < 0 %} {% set rain_adj
      = 0  | int %} {% endif %} {% if rain_adj < 22 %} {% set rain_adj = 0  | int
      %} {% endif %} {{int(rain_adj,0)}}'
    name: irrigation_unlimited_rain_ajastment

- sensor:
  - unit_of_measurement: '%'
    default_entity_id: sensor.irrigation_unlimited_rain_ajastment_drop
    state: '{% set rain_y = float(states(''sensor.irrigation_unlimited_rain_yesterday_24''),
      0) %} {% set rain_n = float(states(''sensor.irrigation_unlimited_rain_today''),
      0) /7 %} {% set rain_t = float(states(''sensor.irrigation_unlimited_rain_tomorrow''),
      0) /8 %} {% set temp_max =states(''sensor.irrigation_unlimited_temp_max_today'')
      | float(-2) %} {% if temp_max < 15 %} {% set temp_adj = 0  | float %} {% elif
      temp_max >=15 and temp_max <21 %} {% set temp_adj =  2/4 | float  %} {% elif
      temp_max >=21 and temp_max <25 %} {% set temp_adj =  2/3 | float  %} {% elif
      temp_max >=25 and temp_max <30 %} {% set temp_adj =  1 | float  %} {% elif temp_max
      >=30 %} {% set temp_adj =  1 | float  %} {% endif %} {% set rain_adj = float((1
      - (rain_y+rain_n+rain_t)), 0)*100 %} {% if rain_adj < 0 %} {% set rain_adj =
      0  | int %} {% endif %} {% if temp_adj == 0 %} {% set rain_adj =
      0  | int %} {% endif %} {% if rain_adj < 15 %} {% set rain_adj = 0  | int %}
      {% endif %} {{int(rain_adj,0)}}'
    name: irrigation_unlimited_rain_ajastment_drop

  ##ONLY FOR V1
  #### Levels of temerature
  #### 15C is temperature to start irrigation - defined in automations as conditions
  #### before 21C - one per 72 days = 6 (Morning & Evening = 2)
  #### above 21C below 25C - one per 48 hours = 4
  #### above 25C below 30C - one per 24 hours = 2
  #### above 30C - one per 12 hours = 1
- sensor:
  - unit_of_measurement: mm
    default_entity_id: sensor.irrigation_unlimited_counter
    state: '{% set temp_max =states(''sensor.irrigation_unlimited_temp_max_today'')
      | float(-2) %} {% if temp_max <19 %} {% set IUC_val = 6  | int %} {% elif temp_max
      >19 and temp_max <23 %} {% set IUC_val = 4  | int %} {% elif temp_max >23 and
      temp_max <28 %} {% set IUC_val = 2  | int %} {% elif temp_max >28 %} {% set
      IUC_val = 1  | int %} {% endif %} {{ (IUC_val) }}'
    name: irrigation_unlimited_counter